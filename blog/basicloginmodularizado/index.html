<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>HasselPunk | Basic LogIn Modularizado</title>
  <meta property="og:title" content="Basic LogIn Modularizado" />
  <meta property="og:image" content="https://www.hasselpunk.com/img/login.jpeg" />
  <meta name="description" content="C√≥mo armar un login b√°sico modular en Shiny">
  <meta property="og:description" content="C√≥mo armar un login b√°sico modular en Shiny" />
  <meta name="author" content="Augusto Hassel">
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
  
  <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">
  <link href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" rel="stylesheet">
  <link href='https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css' rel='stylesheet'>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.min.css" rel="stylesheet">
  
  <link href="/css/resume.css" rel="stylesheet">
  <link href="/css/tweaks.css" rel="stylesheet">
  <meta name="generator" content="Hugo 0.72.0" />
  
   
  
</head>
<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
  <a class="navbar-brand js-scroll-trigger" href="#page-top">
    <span class="d-block d-lg-none">Augusto Hassel</span>
    <span class="d-none d-lg-block">
      <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="/img/AugustoHassel.jpeg" alt="">
    </span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#about">Sobre M√≠</a>
      </li>
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#skills">Habilidades</a>
          </li>
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#projects">Proyectos</a>
          </li>
      
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#experience">Experiencia</a>
          </li>
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#education">Educaci√≥n</a>
          </li>
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#blog">Blog</a>
          </li>
      
    </ul>
  </div>
</nav>

  <div class="container-fluid p-0">
    
<nav aria-label="breadcrumb">
  <ol  class="breadcrumb">
    





<li class="breadcrumb-item">
  <a href="/">HasselPunk</a>
</li>


<li class="breadcrumb-item">
  <a href="/blog/">Blog</a>
</li>


<li class="breadcrumb-item active">
  <a href="/blog/basicloginmodularizado/">Basic LogIn Modularizado</a>
</li>

  </ol>
</nav>




<section class="resume-section p-3 p-lg-5 d-flex d-column">
  <div class="my-auto">
    <h2 class="mb-0"><span class="text-primary">Basic LogIn Modularizado</span></h2>
    <span class="text-primary">February 21, 2020</span>
    


<p><br></p>
<blockquote>
<p>Para los ansiosos como yo: aqu√≠ el <a href="https://github.com/augustohassel/BasicLogInModule">proyecto en GitHub</a> desde donde pueden obtener una versi√≥n b√°sica funcional! üòÅ</p>
</blockquote>
<p>Siendo este es mi primero posteo, va a existir mucha referencia a desarrollos que me encantar√≠a poder explayar pero prometo intentar mantenerme concentrado y, en todo caso, si gustan, continuar√© explay√°ndome en otra ocasi√≥n.</p>
<div id="la-motivaci√≥n" class="section level3">
<h3>La motivaci√≥n</h3>
<p>Desde el momento en que empec√© a armar tableros en Shiny me encontr√© con la necesidad de brindar permisos a usuarios. Esto significa que un usuario pueda, adem√°s de ver o no el contenido completo del sitio, obtener distintos tipos de acceso incluso dentro de las aplicaciones.</p>
<p>Se que existen servicios como <a href="https://auth0.com/">Auth0</a> o, si tienen suerte, la versi√≥n paga de <a href="https://docs.rstudio.com/shiny-server/#authentication-security">Shiny Server Pro</a> desde la cual pueden validar usuarios usando LDAP, Active Directory y otros. Incluso tambi√©n podr√≠an usar <a href="https://www.shinyproxy.io/configuration/#authentication">Shiny Proxy</a>, el cual es open source, para que la validaci√≥n del usuario quede en manos de alguno de los tantos m√©todos existentes.</p>
<p>Por curiosidad, y en ciertos momentos por necesidad, fui creando un log-in que pudiese manejar no solo el ingreso del usuario, sino tambi√©n los distintos tipos de permisos internos y vistas disponibles una vez dentro de la aplicaci√≥n.</p>
Este es el resultado!
<p align="center" width="700px" height="auto">
<img src='/img/login.gif'/>
</p>
<hr />
</div>
<div id="supuestos-y-definiciones" class="section level3">
<h3>Supuestos y definiciones</h3>
<ol style="list-style-type: decimal">
<li><a href="https://shiny.rstudio.com/articles/modules.html">Modules!</a> B√°sicamente los m√≥dulos son como funciones que generan una UI de Shiny y contienen la l√≥gica del servidor asociada. Pero la verdadera m√°gia se da en que, a diferencias de las funciones, estos solucionan el problema del <strong>namespace</strong>, o sea, <strong>podemos reutilizar un mismo modulo m√∫ltiples veces dentro de una misma aplicaci√≥n sin preocuparnos por que los IDs de inputs y outpus sean distintos</strong>!</li>
<li><em>¬øTiene sentido que una funci√≥n de log-in est√© modularizada si solo ser√° usada una sola vez dentro de la aplicaci√≥n?</em> Podr√≠a no estar modularizada! Pero‚Ä¶ me parece un buen caso de uso para empezar a aprende sobre m√≥dulos, al mismo tiempo que es m√°s sencillo para organizar el c√≥digo y tambi√©n para compartirlo.</li>
</ol>
</div>
<div id="manos-a-la-obra" class="section level3">
<h3>Manos a la obra!</h3>
<p>Actualmente <strong>cargo m√≥dulos de dos maneras distintas</strong> dependiendo de si el m√≥dulo es espec√≠fico del tablero en que me encuntro trabajando o si es transversal a todos los tableros (en el caso del login, es el mismo m√≥dulo para todos mis tableros).</p>
<p>Con la <strong>primer opci√≥n</strong> guardo todos los m√≥dulos en una carpeta llamada ‚Äúmodules‚Äù y luego hago un source desde <em>global.R</em>: <code>invisible(lapply(list.files(path = "modules", full.names = T), source))</code>.</p>
<p>Con la <strong>segunda opci√≥n</strong> guardo los m√≥dulos en un repositorio en GitHub y luego hago un source del contenido directamente desde ah√≠! Con esto me aseguro de que solo tengo que modificar en un solo lugar y esto afecta a todos los tableros! Algo as√≠ ser√≠a:</p>
<pre class="r"><code>eval(
  GET(url = &quot;https://api.github.com/repos/XXXXX.R&quot;, 
      authenticate(&quot;username&quot;, &quot;token&quot;), 
      accept(type = &quot;application/vnd.github.v3.raw&quot;)) %&gt;%
    content(as = &quot;text&quot;) %&gt;%
    parse(file = &quot;&quot;, n = NA)
)</code></pre>
<p>Un modulo se compone de dos partes, muy similar a una aplicaci√≥n de Shiny, la primera es una funci√≥n que genera la interfaz y la segunda la que contiene la l√≥gica.</p>
<div id="module-ui" class="section level4">
<h4>Module UI</h4>
<p>En nuestro caso, es bastante sencilla, porque en realidad la UI la genero tambi√©n desde la funci√≥n del server con renderUI. Esto lo hago para poder disparar el Modal!</p>
<pre class="r"><code>login_ui &lt;- function(id) {
  ns &lt;- NS(id)
  tagList(
    uiOutput(ns(&quot;modal_login&quot;))
  )
}</code></pre>
<p>Ac√° lo importante es recordar que los inputs se envuelven con un <code>ns()</code>, esto crea posteriormente la magia para que no se repitan con otros IDs del mismo m√≥dulo en otro lugar de la aplicaci√≥n!</p>
</div>
<div id="module-server" class="section level4">
<h4>Module Server</h4>
<p>El modal que muestra el login contiene la informaci√≥n t√≠pica, <strong>pide un usuario y una contrase√±a</strong>, y adem√°s permite volver a resetear el password! Si quieren probar el reseteo del password en funcionamiento, pueden hacerlo pidi√©ndome un usario para la <a href="https://demo.hasselpunk.com/">versi√≥n demo del BO Companion</a>, donde b√°sicamente se env√≠a un correo usando alg√∫n SMTP (<em>yo uso mailgun o mandrill seg√∫n el cliente</em>) al correo registrado y luego se lee el hash que se genera en el link en la URL para verificar que el usaurio en efecto fue el que pidi√≥ el cambio de contrase√±a.</p>
<p>Los usuarios creados para la versi√≥n demo est√°n cargados en el <em>server.R</em> y son:</p>
<div align="center">
<table>
<thead>
<tr class="header">
<th align="left">Usuario &lt;</th>
<th align="right">&gt; Contrase√±a</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">demo</td>
<td align="right">demo</td>
</tr>
<tr class="even">
<td align="left">juan</td>
<td align="right">juan</td>
</tr>
<tr class="odd">
<td align="left">pedro</td>
<td align="right">pedro</td>
</tr>
</tbody>
</table>
</div>
<p><br></p>
<blockquote>
<p><strong>Aclaraci√≥n</strong>: solo por ser un caso de ejemplo estoy guardando los usuarios en un data frame en el server. En producci√≥n lo tengo todo en bases de datos en la nube en GCloud.</p>
</blockquote>
<p>A la funci√≥n del server <code>function(input, output, session, usuarios_full, usuarios_validos)</code> se le pasan dos listados, el <em>listado completo de usuarios</em> y los <em>usaurios v√°lidos del tablero en cuesti√≥n</em>. Los permisos espec√≠ficos dentro del tablero se eval√∫an en otro lugar!</p>
<p>Hay un <strong>observer</strong> que <em>controla el bot√≥n de login</em> y efect√∫a todas las validaciones correspondientes! Prueben con usuarios que no est√©n en el listado o incluso con todos los usuarios‚Ä¶ hay uno que no tiene permiso para ingresar! En cada caso se da un aviso sobre lo que est√° sucediendo.</p>
<pre class="r"><code>  observeEvent(input$login, {
    
    shinyjs::disable(&quot;login&quot;)
    
    if (input$usuario==&quot;&quot;) {
      sendSweetAlert(session = session, title = &quot;Mmm...&quot;, text = &quot;Debe colcar un usuario para acceder!&quot;, type = &quot;warning&quot;)
    } else if (full_users() %&gt;% filter(UserName == input$usuario) %&gt;% nrow() == 0) {
      sendSweetAlert(session = session, title = &quot;Mmm...&quot;, text = &quot;El usuario no existe!&quot;, type = &quot;warning&quot;)
    } else if (valid_users() %&gt;% filter(UserName == input$usuario) %&gt;% nrow() == 0) {
      sendSweetAlert(session = session, title = &quot;Mmm...&quot;, text = &quot;El usuario no posee acceso a este tablero!&quot;, type = &quot;warning&quot;)
    } else if (valid_users() %&gt;% filter(UserName == input$usuario) %&gt;% pull(Password) %&gt;% is.na()) {
      sendSweetAlert(session = session, title = &quot;Mmm...&quot;, text = HTML(&quot;Debe setear una contrase&amp;ntilde;a, hable con el admin!&quot;), type = &quot;warning&quot;, html = T)
    } else {
      pass_ok &lt;- identical(valid_users() %&gt;% filter(UserName==input$usuario) %&gt;% pull(Password), digest::digest(object = input$password, algo = &quot;sha1&quot;, serialize = F))
      
      if (pass_ok) {
        sendSweetAlert(session = session, title = &quot;Bienvenido!&quot;, type = &quot;success&quot;)
        
        return_values$user &lt;- valid_users() %&gt;% filter(UserName==input$usuario) %&gt;% pull(UserId)
        return_values$person &lt;- valid_users() %&gt;% filter(UserName==input$usuario) %&gt;% pull(PersonaId)
        return_values$permiso &lt;- valid_users() %&gt;% filter(UserName==input$usuario) %&gt;% pull(Permiso)
        
        removeModal()
        
      } else if (!pass_ok) {
        sendSweetAlert(session = session, title = &quot;Error!&quot;, text = HTML(&quot;Contrase&amp;ntilde;a Incorrecta&quot;), type = &quot;error&quot;, html = T)
      }
    }
    
    shinyjs::enable(&quot;login&quot;)</code></pre>
<p><strong>Si el password que tenemos registrado del usuario se condice con el password que el usuario est√° ingresando, entonces ser√° un login exitoso!</strong><br />
<code>identical(valid_users() %&gt;% filter(UserName==input$usuario) %&gt;% pull(Password), digest::digest(object = input$password, algo = "sha1", serialize = F))</code></p>
<p>Otra cosa importante a tener en cuenta que sucede al final de la funci√≥n es que se devuelven valores reactivos dentro de un <code>return_values</code>. Estos me ayudar√°n luego en la aplicaci√≥n principal a tener registradas variables globales como ser el usaurio que se est√° logueando.</p>
</div>
</div>
<div id="y-ahora-la-aplicaci√≥n-principal" class="section level3">
<h3>Y ahora la aplicaci√≥n principal!</h3>
<p>En la aplicaci√≥n principal tenemos que realizar dos tareas, primero en el UI y luego en el SERVER.</p>
<div id="en-el-ui" class="section level4">
<h4>En el UI</h4>
<p>Aqu√≠ agregamos una sola l√≠nea!</p>
<p><code>login_ui("login")</code></p>
<p><strong>login_ui</strong> tiene un solo par√°metro, y es el ID, que en este caso estamos eligiendo como id = ‚Äòlogin‚Äô. Esta es la magia que mencionamos al comienzo, si quisi√©ramos usar el mismo m√≥dulo con distintos par√°metros, solamente tendr√≠amos que preocuparnos por que este ID sea distinto!!!</p>
</div>
<div id="en-el-server" class="section level4">
<h4>En el SERVER</h4>
<p>Aqu√≠ suceden dos cosas importantes, primero llamamos al modulo, pasando el ID que elegimos anteriormente, y le pasamos los par√°metros relevantes (hab√≠amos dicho que eran lo usuarios completos y los que ten√≠an permiso):</p>
<pre class="r"><code>login_result &lt;- callModule(module = login,
                           id = &quot;login&quot;, 
                           usuarios_full = usuarios_full, 
                           usuarios_validos = usuarios_validos)</code></pre>
<p>Luego se brindan los permisos en consecuencia de lo que se haya obtenido. Esto significa que voy a usar <code>shinyjs</code> para mostrar u ocultar partes de la aplicaci√≥n y tambi√©n el men√∫ ser√° distinto seg√∫n el permiso que tenga el usuario gracias a <code>renderMenu</code>:</p>
<pre class="r"><code>observe({
        req(!is_null(login_result$permiso))
        req(!is_null(login_result$person))
        req(!is_null(login_result$user))
        
        if (login_result$permiso %in% c(1)) { # permiso total
            # menu
            output$menu &lt;- renderMenu({
                sidebarMenu(
                    menuItem(text = &quot;Tab&quot;, tabName = &quot;first_page&quot;, icon = icon(&quot;skull&quot;))
                )
            })
            
            # accesos
            shinyjs::hide(&quot;login_page&quot;, anim = T, animType = &quot;slide&quot;)
            shinyjs::show(&quot;first_page_show&quot;) # paginas
            
        } 
        
        global_id_persona(login_result$person)
        global_id_usuario_dashboard(login_result$user)
        
    })</code></pre>
<p>As√≠ es como llegamos al final y logramos tener un log-in b√°sico modularizado! Si hacen un clone del repositorio y corren la aplicaci√≥n de Shiny, van a poder interactuar y seguramente ver√°n algunas cosas extras que est√°n dando vuelta.</p>
<p>Espero que haya servido este primero posteo! Todo feedback es bienvenido!</p>
<blockquote>
<p><strong>Bonus Track</strong>: Sigo a varios repositorios interesante sobre Shiny en Github: miralos <a href="https://github.com/augustohassel?tab=stars">aqu√≠</a></p>
</blockquote>
<p><a href="https://www.buymeacoffee.com/augustohassel" target="_blank"><img src='https://cdn.buymeacoffee.com/buttons/arial-blue.png' alt="Buy Me A Coffee" align="left" height="38"/></a><br><br></p>
</div>
</div>

    
    <ul class="tags">
    
      <li><a class="tag" href="/tags/modules">Modules</a></li>
    
      <li><a class="tag" href="/tags/shiny">Shiny</a></li>
    
      <li><a class="tag" href="/tags/dashboard">Dashboard</a></li>
    
      <li><a class="tag" href="/tags/businessintelligence">BusinessIntelligence</a></li>
    
</ul>

    <div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://hasselpunk.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
  </div>
</section>


    <span style="color: #999999; font-size: 60%;">&nbsp;¬© HasselPunk 2020 + <a href="https://themes.gohugo.io/hugo-resume" target="_blank">Hugo Resume</a></span>
    
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
  
  <script src="/js/resume.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151526241-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-151526241-2');
  </script>
  

  
</body>
</html>
